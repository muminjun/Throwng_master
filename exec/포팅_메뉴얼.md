# 포팅 매뉴얼

## 기술 스택

1. Issue Management
    - JIRA
2. SCM
    - GitLab
3. Communities
    - Notion
    - MatterMost
    - Gather
4. Development Environment
    - React
    - Node.js
    - TypeScript
    - Flutter
    - Kotlin
    - SpringBoot: ^2.7.18
    - SpringCloud:^2021.0.9
    - Docker:  ^4.26.1
    - JVM: Zulu "11.0.21" 2023-10-17 LTS
    - VS Code: 1.85.1
    - IntelliJ: 17.0.9+7-b1087.9 amd64
    - Android 스튜디오 Jellyfish | 2023.3.1
    - DB: Mysql 8.0.28
    - Redis
    - mongoDB
    - Nginx
    - Prometheus
    - Grafana
    - S3
    - Cypress
    - Jenkins
5. ETC
    - 디자인: Figma
    - UCC: Movavi
    - PPT: PowerPoint & Google Slides

## Prod Deployment Command

1. Music Back End Server
    
    ```bash
    pipeline {
    environment { 
        //repository = "alswjd00"  //docker hub id와 repository 이름
        DOCKERHUB_CREDENTIALS = credentials('dockerHub') // jenkins에 등록해 놓은 docker hub credentials 이름
        repository = "alswjd00/throng-dev-music"
        JAR_FILE_PATH = '/var/lib/jenkins/workspace/test_blue_green_batch/back/batch/build/libs'
        dockerImage = '' 
        DEPLOY_PATH = '/home/ubuntu'
    }
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
        
        stage('Read Build Info') {
            steps {
                dir("./back/music") {
                    script {
                        def versionFile = readFile 'build.gradle'
                        def versionMatch = versionFile =~ /version\s+=\s+['"](.+)['"]/
                        echo "${versionMatch}"
                        VERSION = versionMatch ? versionMatch[0][1] : 'Unknown'
                        echo "Build Version: ${VERSION}"
                    }
                }
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/music") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"     
                }
            }
        }
        
        stage('Run script') {
            steps {
                dir("./back/music") {
                    sh "ls"
                    sh "sh ./deploy-prod.sh"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}
```

2. Notification Back End Server
```bash
pipeline {
    environment { 
        //repository = "alswjd00"  //docker hub id와 repository 이름
        DOCKERHUB_CREDENTIALS = credentials('dockerHub') // jenkins에 등록해 놓은 docker hub credentials 이름
        repository = "alswjd00/throng-dev-music"
        JAR_FILE_PATH = '/var/lib/jenkins/workspace/test_blue_green_batch/back/batch/build/libs'
        dockerImage = '' 
        DEPLOY_PATH = '/home/ubuntu'
    }
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
        
        stage('Read Build Info') {
            steps {
                dir("./back/notification") {
                    script {
                        def versionFile = readFile 'build.gradle'
                        def versionMatch = versionFile =~ /version\s+=\s+['"](.+)['"]/
                        echo "${versionMatch}"
                        VERSION = versionMatch ? versionMatch[0][1] : 'Unknown'
                        echo "Build Version: ${VERSION}"
                    }
                }
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/notification") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"     
                }
            }
        }
        
        stage('Run script') {
            steps {
                dir("./back/notification") {
                    sh "ls"
                    sh "sh ./deploy-prod.sh"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
}
```

3. Quiz Back End Server
```bash
pipeline {
    environment { 
        //repository = "alswjd00"  //docker hub id와 repository 이름
        DOCKERHUB_CREDENTIALS = credentials('dockerHub') // jenkins에 등록해 놓은 docker hub credentials 이름
        repository = "alswjd00/throng-dev-music"
        JAR_FILE_PATH = '/var/lib/jenkins/workspace/test_blue_green_batch/back/batch/build/libs'
        dockerImage = '' 
        DEPLOY_PATH = '/home/ubuntu'
    }
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
        
        stage('Read Build Info') {
            steps {
                dir("./back/quiz") {
                    script {
                        def versionFile = readFile 'build.gradle'
                        def versionMatch = versionFile =~ /version\s+=\s+['"](.+)['"]/
                        echo "${versionMatch}"
                        VERSION = versionMatch ? versionMatch[0][1] : 'Unknown'
                        echo "Build Version: ${VERSION}"
                    }
                }
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/quiz") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"     
                }
            }
        }
        
        stage('Run script') {
            steps {
               
                // script {
                //     sshagent(credentials: ['throwngSSH']) {
                //         'scp -o StrictHostKeyChecking=no -P 5112 build/libs/batch-0.0.1-SNAPSHOT.jar ubuntu@13.125.0.190:/home/ubuntu/docker/'
                //         'ssh -p 5112 ubuntu@13.125.0.190 /home/ubuntu/docker/deploy.sh'
                //     }
                // }
                dir("./back/quiz") {
                    sh "ls"
                    sh "sh ./deploy-prod.sh"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}
```

4. User Back End Server
```bash
pipeline {
    environment { 
        //repository = "alswjd00"  //docker hub id와 repository 이름
        DOCKERHUB_CREDENTIALS = credentials('dockerHub') // jenkins에 등록해 놓은 docker hub credentials 이름
        repository = "alswjd00/throng-dev-music"
        JAR_FILE_PATH = '/var/lib/jenkins/workspace/test_blue_green_batch/back/batch/build/libs'
        dockerImage = '' 
        DEPLOY_PATH = '/home/ubuntu'
    }
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
        
        stage('Read Build Info') {
            steps {
                dir("./back/user") {
                    script {
                        def versionFile = readFile 'build.gradle'
                        def versionMatch = versionFile =~ /version\s+=\s+['"](.+)['"]/
                        echo "${versionMatch}"
                        VERSION = versionMatch ? versionMatch[0][1] : 'Unknown'
                        echo "Build Version: ${VERSION}"
                    }
                }
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/user") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"     
                }
            }
        }
        
        stage('Run script') {
            steps {
                dir("./back/user") {
                    sh "ls"
                    sh "sh ./deploy-prod.sh"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}

```

5. Batch Back Server
``` bash
pipeline {
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/batch") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"      // 빌드
                }
            }
        }
        
        stage('Build Docker'){
            steps{
                script{
                    sh "docker build -t back-batch:${env.BUILD_NUMBER} back/batch/"
                }
            }
        }
        
        stage('Deploy Docker'){
            steps{
                script{
                    sh "docker stop back-batch || true && docker rm back-batch || true"
                    sh "docker run -p 8083:8083 --name back-batch -d --network connect-default -e TZ=Asia/Seoul back-batch:${env.BUILD_NUMBER}"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}

```

6. Config Back Server
```bash
pipeline {
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/config") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"      // 빌드
                }
            }
        }
        
        stage('Build Docker'){
            steps{
                script{
                    sh "docker build -t back-config:${env.BUILD_NUMBER} back/config/"
                }
            }
        }
        
        stage('Deploy Docker'){
            steps{
                script{
                    sh "docker stop back-config || true && docker rm back-config || true"
                    sh "docker run -p 8088:8088 --name back-config -d --network connect-default -e TZ=Asia/Seoul back-config:${env.BUILD_NUMBER}"
                    sh "docker image prune -a -f || true"
                }
            }
        }

    }
}
```

7. Discovery Back Server
```bash
pipeline {
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/discovery") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"      // 빌드
                }
            }
        }
        
        stage('Build Docker'){
            steps{
                script{
                    sh "docker build -t back-discovery:${env.BUILD_NUMBER} back/discovery/"
                }
            }
        }
        
        stage('Deploy Docker'){
            steps{
                script{
                    sh "docker stop back-discovery || true && docker rm back-discovery || true"
                    sh "docker run -p 8761:8761 --name back-discovery -d --network connect-default -e TZ=Asia/Seoul back-discovery:${env.BUILD_NUMBER}"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}
```

8. Gateway Back Server
```bash
pipeline {
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/gateway") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"      // 빌드
                }
            }
        }
        
        stage('Build Docker'){
            steps{
                script{
                    sh "docker build -t back-gateway:${env.BUILD_NUMBER} back/gateway/"
                }
            }
        }
        
        stage('Deploy Docker'){
            steps{
                script{
                    sh "docker stop back-gateway || true && docker rm back-gateway || true"
                    sh "docker run -p 8081:8081 --name back-gateway -d --network connect-default -e TZ=Asia/Seoul back-gateway:${env.BUILD_NUMBER}"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}
```
    
9. Front End Server
    
```bash
pipeline {
    agent any
        
    stages {
        stage('Git Clone') {
            steps {
                checkout scmGit(
                    branches: [[name: 'master']],
                    extensions: [submodule(parentCredentials: true, reference: '', trackingSubmodules: true)],
                    userRemoteConfigs: [[credentialsId: 'throwng_sinwoong', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git']]
                )
            }
        }
        
        stage("Build") {
            steps {
                dir("./front"){
                    script {
                        sh "ls -al"
                        sh "docker build -t front:${env.BUILD_NUMBER} -f prod.Dockerfile ."
                        //sh "docker build -t front:${env.BUILD_NUMBER} front"
                    }
                }
            }
        }

        stage('Deploy Docker'){
            steps{
                script{
                    sh "docker stop front || true && docker rm front || true"
                    sh "docker run -p 9003:4173 --name front -d --network connect-default -e TZ=Asia/Seoul front:${env.BUILD_NUMBER}"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }

    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}
```

## MySQL WorkBench Connection

1. Spring Boot에서 연결
    1. application.properties
    
    ```jsx
    spring.datasource.url=jdbc:mysql://{호스트명}:3307/throwng?serverTimezone=UTC&characterEncoding=UTF-8
    spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
    spring.datasource.username="mysql 계정 아이디"
    spring.datasource.password="mysql 계정 비밀번호"
    ```
    
    b. “스키마 이름”과 동일한 이름의 스키마를 생성
    
2. Standard TCP/IP 연결
    1. MySql Workbench에서 NewConnection
    - Connection Name: 관리용 이름
    - Connection Method: Standard (TCP/IP)
    - HostName: Public DNS 또는 Public IP
    - Port: Mysql이 설치된 포트
    - UserName: 사용자 입력
    - Password: Store in Vault … 을 클릭 후 입력
    - Test Connection을 누르고 에러 메세지가 뜨지 않으면 OK를 누른다.

## /etc/nginx/sites-available/default
```bash
limit_req_zone $binary_remote_addr zone=ddos_req:10m rate=5r/s;
limit_conn_zone $binary_remote_addr zone=ddos_conn:10m;
limit_req_status 429;
client_max_body_size 10M;

server {
        listen 443;

        ssl on;
        ssl_certificate /etc/ssl/certificate.crt;
        ssl_certificate_key /etc/ssl/private.key;

        server_name sieum.co.kr;
        client_body_timeout 10s;
        client_header_timeout 10s;
        autoindex_localtime on;

        access_log /var/log/nginx/nginx.vhost.access.log;
        error_log /var/log/nginx/nginx.vhost.error.log;

        location / {
                proxy_pass http://localhost:9003;
        }

        location /api/ {
                proxy_pass http://localhost:8081/;
                limit_req zone=ddos_req burst=5;
                limit_conn ddos_conn 10;
        }

        location /jenkins/ {
 #               root /var/www/html;
  #              index index.html index.htm index.nginx-debian.html;
                proxy_pass http://localhost:8080/;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X_Forearded-Proto $scheme;
        }

        location /grafana-server {
                proxy_pass http://localhost:3000;
        }

#       location /jenkins {
#               proxy_pass http://localhost:8080;
#       }

}

server{
        if ($host = www.sieum.co.kr){
                return 301 https://$host$request_uri;
        }

        listen 80;
        listen [::]:80;
        server_name sieum.co.kr;
        return 404;
}
```

## Spring yml 설정


## EC2 Setting


## .gitignore

```bash
back/HELP.md
.gradle
build/
!gradle/wrapper/gradle-wrapper.jar
!**/src/main/**/build/
!**/src/test/**/build/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache
bin/
!**/src/main/**/bin/
!**/src/test/**/bin/

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr
out/
!**/src/main/**/out/
!**/src/test/**/out/

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/

### VS Code ###
.vscode/

```

## Settings or Tips

1. 환경 변수 설치
    
    ```bash
    git submodule init
    git submodule update
    git submodule update --remote
    ```
    
2. 외부 서비스 사용
    1. KaKao Oauth
        - https://kauth.kakao.com/oauth/token
        - https://kapi.kakao.com/v2/user/me
        - https://kapi:kakao:com/v1/user/unlink
    2. Kakao Convert coordinates to administrative information
        - https://dapi.kakao.com/v2/local/geo/coord2regioncode
    3. Google Map
    4. Sotify
        - https://api.spotify.com/v1/search

## 시연 시나리오
